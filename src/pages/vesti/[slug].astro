---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import NewsContent from '../../components/news/NewsContent.astro';
import SocialShare from '../../components/shared/SocialShare.astro';
import GalleryLink from '../../components/shared/GalleryLink.astro';
import NewsArticleSchema from '../../components/seo/NewsArticleSchema.astro';
import { formatDate } from '../../utils/formatDate';
import { getFirstImage } from '../../utils/getFirstImage';
import { getGalleryLinkForContent } from '../../utils/getGalleryLink';

export const getStaticPaths = (async () => {
  const allNews = await getCollection('vesti');

  return allNews.map((news) => {
    // Extract ID from filename (vest_XXX.json -> XXX)
    const id = news.id.replace('vest_', '').replace('.json', '');
    return {
      params: { slug: id },
      props: { news },
    };
  });
}) satisfies GetStaticPaths;

const { news } = Astro.props;

// Get page number from URL query parameter, default to 1
const pageParam = Astro.url.searchParams.get('page');
const backToPage = pageParam ? parseInt(pageParam) : 1;

// Get first image for Open Graph
const firstImage = getFirstImage(news.data.content);

// Get published time for article metadata
const publishedTime = news.data.date?.toISOString();

// Get linked gallery event
const linkedGalleryEvent = getGalleryLinkForContent('vesti', news.id);

// Generate meta description from content
import { getExcerpt } from '../../utils/excerpt';
const metaDescription = getExcerpt(news.data.content, 160) || news.data.title;
---

<BaseLayout
  title={news.data.title}
  description={metaDescription}
  type="article"
  image={firstImage}
  publishedTime={publishedTime}
>
  <!-- Schema.org Structured Data -->
  <NewsArticleSchema
    slot="head"
    title={news.data.title}
    description={metaDescription}
    image={firstImage}
    datePublished={publishedTime || new Date().toISOString()}
    url={Astro.url.pathname}
  />

  <Header />

  <main class="container mx-auto px-4 py-8 max-w-4xl flex-grow">
    <article>
      <header class="mb-8">
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-kk-text-primary mb-4">
          {news.data.title}
        </h1>
        <time class="text-kk-accent font-medium">
          {news.data.date ? formatDate(news.data.date) : ''}
        </time>
      </header>

      <NewsContent content={news.data.content} />

      {linkedGalleryEvent && (
        <GalleryLink event={linkedGalleryEvent} />
      )}

      <footer class="mt-8 pt-8 border-t">
        <SocialShare
          title={news.data.title}
          url={Astro.url.href}
        />
      </footer>
    </article>

    <div class="mt-8">
      <button onclick="history.back()" class="btn btn-outline btn-primary">
        ‚Üê Nazad na vesti
      </button>
    </div>
  </main>

  <Footer />
</BaseLayout>
