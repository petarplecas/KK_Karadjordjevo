---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import NewsCard from '../components/news/NewsCard.astro';
import { slugify } from '../utils/slugify';
import { truncateText } from '../utils/truncateText';

// Get all news and sort by date (newest first)
const allNews = await getCollection('vesti');
const sortedNews = allNews.sort((a, b) =>
  b.data.date.getTime() - a.data.date.getTime()
);

// Get first 10 for homepage
const latestNews = sortedNews.slice(0, 10);

// Create excerpts from first text block
function getExcerpt(content: any[]): string {
  const firstText = content.find(item => item.type === 'text');
  return firstText ? truncateText(firstText.value, 150) : '';
}
---

<BaseLayout title="Početna">
  <Header />

  <main class="container mx-auto px-4 py-8 flex-grow">
    <h1 class="text-3xl sm:text-4xl font-bold text-center mb-8 text-kk-primary">
      Najnovije vesti
    </h1>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {latestNews.map((news) => (
        <NewsCard
          title={news.data.title}
          date={news.data.date}
          excerpt={getExcerpt(news.data.content)}
          slug={slugify(news.data.title)}
        />
      ))}
    </div>

    <div class="text-center mt-8">
      <a href="/vesti/1" class="btn btn-primary btn-lg">
        Sve vesti →
      </a>
    </div>
  </main>

  <Footer />
</BaseLayout>
